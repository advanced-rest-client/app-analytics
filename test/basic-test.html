<!doctype html>
<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../web-component-tester/browser.js"></script>
    <script src="../../iron-test-helpers/test-helpers.js"></script>
    <script src="../../iron-test-helpers/mock-interactions.js"></script>

    <!-- Step 1: import the element to test -->
    <link rel="import" href="../app-analytics.html">
  </head>
  <body>

    <test-fixture id="basic">
      <template>
        <app-analytics tracking-id="UA-71458341-4" app-name="app-analytics-test" app-version="dev" data-source="app-analytics element"></app-analytics>
      </template>
    </test-fixture>

    <test-fixture id="disabled">
      <template>
        <app-analytics disable-tracking tracking-id="UA-71458341-4" app-name="app-analytics-test" app-version="dev" data-source="app-analytics element"></app-analytics>
      </template>
    </test-fixture>

    <script>
    // jscs:disable
    /* jshint ignore:start */
    suite('basic', function() {
      var element;
      var cids = [];

      suiteTeardown(function() {
        var db = new PouchDB('analytics-meta');
        return db.destroy();
      });

      setup(function() {
        element = fixture('basic');
      });

      test('Initialize the cid', function(done) {
        element.addEventListener('app-analytics-ready', function() {
          cids.push(element.clientId);
          // saving nevly generated meta may take a few milliseconds...
          // Otherwise next test will generate new CID.
          setTimeout(function() {
            done();
          }, 100);
        });
      });

      test('Enabled by default', function(done) {
        element.addEventListener('app-analytics-ready', function() {
          assert.equal(element.disableTracking, false);
          cids.push(element.clientId);
          done();
        });
      });

      test('Disable tracking', function(done) {
        element.disableTracking = true;
        element.addEventListener('app-analytics-ready', function() {
          assert.equal(element.disableTracking, true);
          cids.push(element.clientId);
          done();
        });
      });

      test('Disabled won\'t send hit', function(done) {
        element.addEventListener('app-analytics-ready', function() {
          // disabled in previous test, it test persistancy
          element.sendHit('screenview', {
            cd: 'test'
          })
          .then((result) => {
            expect(result).to.exist;
            expect(result.disabled).to.equal(true);
          });

          cids.push(element.clientId);
          done();
        });
      });

      test('Enable tracking', function(done) {
        element.disableTracking = false;
        element.addEventListener('app-analytics-ready', function() {
          assert.equal(element.disableTracking, false);
          cids.push(element.clientId);
          done();
        });
      });

      // Put this at the end of suite.
      test('Cid hasn\'t changed', function(done) {
        element.addEventListener('app-analytics-ready', function() {
          cids.push(element.clientId);
          var _cid;
          expect(cids).to.be.not.empty;
          cids.forEach(function(cid) {
            expect(cid).to.be.not.empty;
            if (!_cid) {
              _cid = cid;
            } else {
              expect(_cid).to.equal(cid);
            }
          });
          done();
        });
      });
    });

    suite('disbaled', function() {
      var element;

      suiteTeardown(function() {
        var db = new PouchDB('analytics-meta');
        return db.destroy();
      });

      setup(function() {
        element = fixture('disabled');
      });

      test('Should be disabled after initialization', function(done) {
        element.addEventListener('app-analytics-ready', function() {
          assert.equal(element.disableTracking, true);
          done();
        });
      });
    });
    </script>

  </body>
</html>
