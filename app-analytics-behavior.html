<!--
@license
Copyright 2016 The Advanced REST client authors <arc@mulesoft.com>
Licensed under the Apache License, Version 2.0 (the "License"); you may not
use this file except in compliance with the License. You may obtain a copy of
the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
License for the specific language governing permissions and limitations under
the License.
-->
<link rel="import" href="../polymer/polymer.html">
<script>
(function() {
  'use strict';
  if (!('ArcBehaviors' in window)) {
    window.ArcBehaviors = {};
  }
  /**
   * Common function implementing Google's measurement protocol.
   * @polymerBehavior
   */
  ArcBehaviors.AppAnalyticsBehavior = {
    /**
     * Fired when `debugEndpoint` is set to `true`. Contains a validation
     * result from the GA server.
     * The result is in following format:
     * ```javascript
     * {
     *   "hitParsingResult": [{
     *     "valid": false,
     *     "hit": "GET /debug/collect?tid=fake\u0026v=1 HTTP/1.1",
     *     "parserMessage": [{
     *       "messageType": "ERROR",
     *       "description": "The value provided for parameter ...",
     *       "parameter": "tid"
     *     }, {
     *       "messageType": "ERROR",
     *       "description": "Tracking Id is a required field ...",
     *       "parameter": "tid"
     *     }]
     *   }]
     * }
     * ```
     *
     * @event app-analytics-structure-debug
     * @param {Object} debug A validation result from the GA server.
     */
    properties: {
      /**
       * If set then the tracking will be disabled any all calls will be
       * void.
       */
      disableTracking: {
        type: Boolean
      },
      /**
       * The Client ID for the mearusement protocol.
       *
       * **It is required for all types of calls.**
       *
       * The value of this field should be a random UUID (version 4) as described
       * in http://www.ietf.org/rfc/rfc4122.txt
       *
       * - Parameter: **cid**
       * - Example value: 35009a79-1a05-49d7-b876-2b884d0f825b
       * - Example usage: cid=35009a79-1a05-49d7-b876-2b884d0f825b
       */
      clientId: {
        type: String,
        value: ''
      },
      /**
       * This is intended to be a known identifier for a user provided by the site owner/tracking
       * library user. It must not itself be PII (personally identifiable information).
       * The value should never be persisted in GA cookies or other Analytics provided storage.
       *
       * - Parameter: **uid**
       * - Example value: as8eknlll
       * - Example usage: uid=as8eknlll
       *
       */
      userId: {
        type: String,
        value: ''
      },
      /**
       * **Required for all hit types.**
       *
       * The Protocol version. The current value is '1'. This will only change when there
       * are changes made that are not backwards compatible.
       *
       * - Parameter: **v**
       * - Example value: 1
       * - Example usage: v=1
       */
      protocolVersion: {
        type: String,
        value: '1',
        readOnly: true
      },
      /**
       * **Required for all hit types.**
       *
       * The tracking ID / web property ID. The format is UA-XXXX-Y.
       * All collected data is associated by this ID.
       *
       * - Parameter: **tid**
       * - Example value: UA-XXXX-Y
       * - Example usage: tid=UA-XXXX-Y
       */
      trackingId: String,
      /**
       * When present, the IP address of the sender will be anonymized.
       * For example, the IP will be anonymized if any of the following parameters are present in
       * the payload: &aip=, &aip=0, or &aip=1
       *
       * - Parameter: **aip**
       * - Example value: 1
       * - Example usage: aip=1
       */
      anonymizeIp: {
        type: Boolean,
        value: false
      },
      /**
       * Indicates the data source of the hit. Hits sent from analytics.js will have data source
       * set to 'web'; hits sent from one of the mobile SDKs will have data source set to 'app'.
       *
       * - Parameter: **ds**
       * - Example value: call center
       * - Example usage: ds=call%20center
       */
      dataSource: {
        type: String,
        value: ''
      },
      /**
       * Used to send a random number in GET requests to ensure browsers and proxies
       * don't cache hits.
       *
       * - Parameter: **z**
       * - Example value: 289372387623
       * - Example usage: z=289372387623
       */
      useCacheBooster: Boolean,
      /**
       * Specifies which referral source brought traffic to a website. This value is also used to
       * compute the traffic source. The format of this value is a URL.
       *
       * - Parameter: **dr**
       * - Example value: http://example.com
       * - Example usage: dr=http%3A%2F%2Fexample.com
       */
      referrer: {
        type: String,
        value: ''
      },
      /**
       * Specifies the campaign name.
       *
       * - Parameter: **cn**
       * - Example value: (direct)
       * - Example usage: cn=%28direct%29
       */
      campaignName: {
        type: String,
        value: ''
      },
      /**
       * Specifies the campaign source.
       *
       * - Parameter: **cs**
       * - Example value: (direct)
       * - Example usage: cs=%28direct%29
       */
      campaignSource: {
        type: String,
        value: ''
      },
      /**
       * Specifies the campaign medium.
       *
       * - Parameter: **cm**
       * - Example value: organic
       * - Example usage: cm=organic
       */
      campaignMedium: {
        type: String,
        value: ''
      },
      /**
       * Specifies the application version.
       *
       * - Parameter: **av**
       * - Example value: 1.2
       * - Example usage: av=1.2
       */
      appVersion: {
        type: String,
        value: ''
      },
      /**
       * Specifies the application name. This field is required for any hit that has app related
       * data (i.e., app version, app ID, or app installer ID). For hits sent to web properties,
       * this field is optional.
       *
       * - Parameter: **an**
       * - Example My App
       * - Example usage: an=My%20App
       */
      appName: String,
      /**
       * Application identifier.
       *
       * - Parameter: **aid**
       * - Example value: com.company.app
       * - Example usage: aid=com.company.app
       */
      appId: {
        type: String,
        value: ''
      },
      /**
       * Application installer identifier.
       *
       * - Parameter: **aiid**
       * - Example value: com.platform.vending
       * - Example usage: aiid=com.platform.vending
       */
      appInstallerId: {
        type: String,
        value: ''
      },
      /**
       * Each custom metric has an associated index. There is a maximum of 20 custom
       * metrics (200 for Analytics 360 accounts). The metric index must be a positive
       * integer between 1 and 200, inclusive.
       *
       * - Parameter: **cm<metricIndex>**
       * - Example value: 47
       * - Example usage: cm1=47
       */
      customMetrics: {
        type: Array,
        readOnly: true,
        value: function() {
          return [];
        }
      },
      /**
       * Each custom dimension has an associated index. There is a maximum of 20 custom
       * dimensions (200 for Analytics 360 accounts). The dimension index must be a positive
       * integer between 1 and 200, inclusive.
       *
       * - Parameter: **cd<dimensionIndex>**
       * - Example value: Sports
       * - Example usage: cd1=Sports
       */
      customDimensions: {
        type: Array,
        readOnly: true,
        value: function() {
          return [];
        }
      },

      // If true then the library is initialized.
      inited: {
        type: Boolean,
        value: false,
        readOnly: true,
        notify: true
      },
      // Generated POST parameters based on a params
      baseParams: {
        type: Array,
        readOnly: true,
        value: function() {
          return [];
        }
      },
      /**
       * If set to true it will prints debug messages into the console.
       */
      debug: Boolean,
      /**
       * If set it will send the data to GA's debug endpoint
       * and the request won't be actually saved but only validated
       * and the validation results will be fired in the
       * `aapp-analytics-structure-debug`
       * event in the detail's `debug` property.
       */
      debugEndpoint: Boolean,

      _paramsMap: {
        type: Object,
        readOnly: true,
        value: function() {
          var data = {
            v: 'Protocol Version',
            tid: 'Tracking ID / Web Property ID',
            aip: 'Anonymize IP',
            ds: 'Data Source',
            qt: 'Queue Time',
            z: 'Cache Buster',
            cid: 'Client ID',
            uid: 'User ID',
            sc: 'Session Control',
            uip: 'IP Override',
            ua: 'User Agent Override',
            geoip: 'Geographical Override',
            dr: 'Document Referrer',
            cn: 'Campaign Name',
            cs: 'Campaign Source',
            cm: 'Campaign Medium',
            ck: 'Campaign Keyword',
            cc: 'Campaign Content',
            ci: 'Campaign ID',
            gclid: 'Google AdWords ID',
            dclid: 'Google Display Ads ID',
            sr: 'Screen Resolution',
            vp: 'Viewport size',
            de: 'Document Encoding',
            sd: 'Screen Colors',
            ul: 'User Language',
            je: 'Java Enabled',
            fl: 'Flash Version',
            t: 'Hit type',
            ni: 'Non-Interaction Hit',
            dl: 'Document location URL',
            dh: 'Document Host Name',
            dp: 'Document Path',
            dt: 'Document Title',
            cd: 'Screen Name',
            linkid: 'Link ID',
            an: 'Application Name',
            aid: 'Application ID',
            av: 'Application Version',
            aiid: 'Application Installer ID',
            ec: 'Event Category',
            ea: 'Event Action',
            el: 'Event Label',
            ev: 'Event Value',
            sn: 'Social Network',
            sa: 'Social Action',
            st: 'Social Action Target',
            utc: 'User timing category',
            utv: 'User timing variable name',
            utt: 'User timing time',
            utl: 'User timing label',
            plt: 'Page Load Time',
            dns: 'DNS Time',
            pdt: 'Page Download Time',
            rrt: 'Redirect Response Time',
            tcp: 'TCP Connect Time',
            srt: 'Server Response Time',
            dit: 'DOM Interactive Time',
            clt: 'Content Load Time',
            exd: 'Exception Description',
            exf: 'Is Exception Fatal?',
            xid: 'Experiment ID',
            xvar: 'Experiment Variant'
          };
          for (let i = 1; i < 201; i++) {
            data['cd' + i] = 'Custom dimension #' + i;
            data['cm' + i] = 'Custom metric #' + i;
          }
          return data;
        }
      }
    },

    observers: [
      '_configureBaseParams(inited, clientId, userId, trackingId, anonymizeIp, dataSource, ' +
        'referrer, campaignName, campaignSource, campaignMedium, appVersion, appName, appId, ' +
        'appInstallerId, customDimensions.*, customMetrics.*)',
      '_cidChanged(clientId)'
    ],

    _cidChanged: function(clientId) {
      if (clientId) {
        this._setInited(true);
      }
    },
    /**
     * Sets custom dimension to be send with the hit.
     * Set dimension will be used in all hits until `removeCustomDimension()` is called
     * with the same `index`.
     *
     * Custom dimensions can be set in GA admin interface an its index will be displayed there.
     *
     * @param {Number} index Index of the custom dimension. Free version of GA allows up to 20
     * custom dimensions and up to 200 in premium. The index has to be in range 1 - 200.
     * @param {Strnig} value Value of the custom dimension to set.
     */
    addCustomDimension: function(index, value) {
      index = Number(index);
      if (index !== index) {
        throw new Error('Index is not a number.');
      }
      if (index <= 0 || index > 200) {
        throw new Error('Index out of bounds');
      }
      var pos = this.customDimensions.findIndex((i) => i.index === index);
      if (pos !== -1) {
        this.set(`customDimensions.${pos}.value`, value);
        return;
      }
      this.push('customDimensions', {
        index: index,
        value: value
      });
    },
    /**
     * Removes from this instance custom dimension for given index.
     *
     * @param {Number} index Index of the custom dimension. The index has to be in range 1 - 200.
     */
    removeCustomDimension: function(index) {
      index = Number(index);
      var pos = this.customDimensions.findIndex((i) => i.index === index);
      if (pos === -1) {
        return;
      }
      this.splice('customDimensions', pos, 1);
    },
    /**
     * Sets custom metric to be send with the hit.
     * Set metric will be used in all hits until `removeCustomMetric()` is called
     * with the same `index`.
     *
     * Custom metrics can be set in GA admin interface an its index will be displayed there.
     *
     * @param {Number} index Index of the custom metric. Free version of GA allows up to 20
     * custom metrics and up to 200 in premium. The index has to be in range 1 - 200.
     * @param {Strnig} value Value of the custom metric to set.
     */
    addCustomMetric: function(index, value) {
      index = Number(index);
      if (index !== index) {
        throw new Error('Index is not a number.');
      }
      if (index <= 0 || index > 200) {
        throw new Error('Index out of bounds');
      }
      var pos = this.customMetrics.findIndex((i) => i.index === index);
      if (pos !== -1) {
        this.set(`customMetrics.${pos}.value`, value);
        return;
      }
      this.push('customMetrics', {
        index: index,
        value: value
      });
    },
    /**
     * Removes from this instance custom metric for given index.
     *
     * @param {Number} index Index of the custom metric. The index has to be in range 1 - 200.
     */
    removeCustomMetric: function(index) {
      index = Number(index);
      var pos = this.customMetrics.findIndex((i) => i.index === index);
      if (pos === -1) {
        return;
      }
      this.splice('customMetrics', pos, 1);
    },
    /**
     * Sends the screenview hit to the GA.
     *
     * @param {String} name Screen name.
     * @param {Object} opts Custom data definition. It should be an object that may contain two
     * keys: `customDimensions` and `customMetrics`. Both as an array of objects. Each object must
     * contain `index` property - representing custom data index in GA - and `value` property -
     * representing value of the property.
     */
    sendScreen: function(name, opts) {
      if (this.disableTracking) {
        return;
      }
      var data = {
        cd: name
      };
      this.appendCustomData(data, opts);
      this.sendHit('screenview', data);
    },
    /**
     * Sends event tracking.
     *
     * @param {String} category Specifies the event category. Must not be empty.
     * @param {String} action Specifies the event action. Must not be empty.
     * @param {String?} label Specifies the event label. Optional value.
     * @param {Number?} value Specifies the event value. Values must be non-negative. Optional.
     * @param {Object} opts Custom data definition. It should be an object that may contain two
     * keys: `customDimensions` and `customMetrics`. Both as an array of objects. Each object must
     * contain `index` property - representing custom data index in GA - and `value` property -
     * representing value of the property.
     */
    sendEvent: function(category, action, label, value, opts) {
      if (this.disableTracking) {
        return;
      }
      var missing = [];
      if (!category) {
        missing.push('category');
      }
      if (!action) {
        missing.push('action');
      }
      if (missing.length) {
        throw new Error('Missing required parameters: ' + missing.join(', '));
      }
      var data = {
        ec: category,
        ea: action
      };
      if (label) {
        data.el = label;
      }
      if (value) {
        data.ev = value;
      }
      this.appendCustomData(data, opts);
      this.sendHit('event', opts);
    },
    /**
     * Sends the exception hit to GA.
     *
     * @param {String} description A description of the exception.
     * @param {Boolean} fatal Specifies whether the exception was fatal.
     * @param {Object} opts Custom data definition. It should be an object that may contain two
     * keys: `customDimensions` and `customMetrics`. Both as an array of objects. Each object must
     * contain `index` property - representing custom data index in GA - and `value` property -
     * representing value of the property.
     */
    sendException: function(description, fatal, opts) {
      if (this.disableTracking) {
        return;
      }
      fatal = fatal ? '1' : '0';
      var data = {
        exd: description,
        exf: fatal
      };
      this.appendCustomData(data, opts);
      this.sendHit('exception', data);
    },
    /**
     * Track social interaction
     *
     * @param {String} network Specifies the social network, for example Facebook or Google Plus.
     * @param {String} action Specifies the social interaction action. For example on Google Plus
     * when a user clicks the +1 button, the social action is 'plus'.
     * @param {String} target Specifies the target of a social interaction. This value is
     * typically a URL but can be any text.
     * @param {Object} opts Custom data definition. It should be an object that may contain two
     * keys: `customDimensions` and `customMetrics`. Both as an array of objects. Each object must
     * contain `index` property - representing custom data index in GA - and `value` property -
     * representing value of the property.
     */
    sendSocial: function(network, action, target, opts) {
      if (this.disableTracking) {
        return;
      }
      var missing = [];
      if (!network) {
        missing.push('network');
      }
      if (!action) {
        missing.push('action');
      }
      if (!target) {
        missing.push('target');
      }
      if (missing.length) {
        throw new Error('Missing required parameters: ' + missing.join(', '));
      }
      var data = {
        sn: network,
        sa: action,
        st: target
      };
      this.appendCustomData(data, opts);
      this.sendHit('social', data);
    },
    /**
     * Track timings in the app.
     *
     * @param {String} category Specifies the user timing category. **required**
     * @param {String} variable Specifies the user timing variable. **required**
     * @param {Number} time Specifies the user timing value. The value is in milliseconds.
     * **required**
     * @param {String} label Specifies the user timing label.
     * @param {Object} opts Custom data definition. It should be an object that may contain two
     * keys: `customDimensions` and `customMetrics`. Both as an array of objects. Each object must
     * contain `index` property - representing custom data index in GA - and `value` property -
     * representing value of the property.
     */
    sendTimings: function(category, variable, time, label, cmOpts) {
      if (this.disableTracking) {
        return;
      }
      var missing = [];
      if (!category) {
        missing.push('category');
      }
      if (!variable) {
        missing.push('variable');
      }
      if (!time) {
        missing.push('time');
      }
      if (missing.length) {
        throw new Error('Missing required parameters: ' + missing.join(', '));
      }
      var opts = {
        utc: category,
        utv: variable,
        utt: time
      };
      if (label) {
        opts.utl = label;
      }
      this.appendCustomData(opts, cmOpts);
      this.sendHit('timing', opts);
    },
    /**
     * Append custom metrics / dimensions definitions to the
     * parameters list.
     */
    appendCustomData: function(data, opts) {
      if (!opts) {
        return;
      }
      if (opts.customDimensions && opts.customDimensions.length) {
        opts.customDimensions.forEach((item) => {
          data['cd' + item.index] = encodeURIComponent(item.value);
        });
      }
      if (opts.customMetrics && opts.customMetrics.length) {
        opts.customMetrics.forEach((item) => {
          data['cm' + item.index] = encodeURIComponent(item.value);
        });
      }
    },
    /**
     * Send a hit to the GA server.
     * The `type` parameter is required for all types of hits.
     *
     * @param {String} type The type of hit. Must be one of 'pageview', 'screenview', 'event',
     * 'transaction', 'item', 'social', 'exception', 'timing'.
     * @param {Array<String,String>} map of params to send wit this hit.
     */
    sendHit: function(type, params) {
      if (this.disableTracking) {
        return;
      }
      if (['pageview', 'screenview', 'event', 'transaction', 'item', 'social', 'exception',
        'timing'].indexOf(type) === -1) {
        throw new Error('Unknown hit type.');
      }
      params.t = type;
      this._processParams(params);
      var post = Object.assign({}, this.baseParams, params);
      var body = this._createBody(post);
      if (this.debug) {
        console.group('Running command for ', type);
        this._printParamsTable(post);
        console.groupEnd();
      }
      this._transport(body);
    },

    _processParams: function(params) {
      for (let param in params) {
        params[param] = encodeURIComponent(params[param]);
      }
    },
    // Creates a post body from the params.
    _createBody: function(params) {
      var result = '';
      for (let param in params) {
        if (result) {
          result += '&';
        }
        result += param + '=' + params[param];
      }
      return result;
    },

    _configureBaseParams: function(inited, clientId, userId, trackingId, anonymizeIp, dataSource,
      referrer, campaignName, campaignSource, campaignMedium, appVersion, appName, appId,
      appInstallerId) {

      if (!inited) {
        return;
      }
      var data = {
        v: this.protocolVersion,
        tid: trackingId,
        cid: clientId,
        ul: navigator.language,
        sr: screen.width + 'x' + screen.height,
        sd: screen.pixelDepth,
        vp: window.innerWidth + 'x' + window.innerHeight
      };
      var iw = window.innerWidth;
      var ih = window.innerHeight;
      if (iw && ih) {
        data.vp = iw + 'x' + ih;
      }

      if (userId) {
        data.uid = userId;
      }
      if (anonymizeIp) {
        data.aip = '1';
      }
      if (dataSource) {
        data.ds = encodeURIComponent(dataSource);
      }
      if (referrer) {
        data.dr = encodeURIComponent(referrer);
      }
      if (campaignName) {
        data.cn = encodeURIComponent(campaignName);
      }
      if (campaignSource) {
        data.cs = encodeURIComponent(campaignSource);
      }
      if (campaignMedium) {
        data.cm = encodeURIComponent(campaignMedium);
      }
      if (appVersion) {
        data.av = encodeURIComponent(appVersion);
      }
      if (appName) {
        data.an = encodeURIComponent(appName);
      }
      if (appId) {
        data.aid = encodeURIComponent(appId);
      }
      if (appInstallerId) {
        data.appInstallerId = encodeURIComponent(appInstallerId);
      }

      if (this.customMetrics.length) {
        this.customMetrics.forEach((cm) => {
          data['cm' + cm.index] = encodeURIComponent(cm.value);
        });
      }
      if (this.customDimensions.length) {
        this.customDimensions.forEach((cd) => {
          data['cd' + cd.index] = encodeURIComponent(cd.value);
        });
      }
      if (this.debug) {
        console.info('[GA] Configuring base object', data);
      }
      this._setBaseParams(data);
    },

    _printParamsTable: function(list) {
      var map = {};
      var debugList = [];
      for (let param in list) {
        let name = this._paramsMap[param] || param;
        let value = decodeURIComponent(list[param]);
        map[param] = {
          value: value,
          name: name
        };
        debugList.push({
          param: param,
          value: value,
          name: name
        });
      }
      console.table(map, ['name', 'value']);
      this.fire('app-analytics-hit-debug', {
        debug: debugList
      });
    },

    _printFromBulk: function(body) {
      body = body.split('\n');
      if (!body.length) {
        return;
      }
      var innserSplit = (pair) => {
        pair = pair.split('=');
        return pair;
      };

      console.group('Running bulk insert');

      body.forEach((i) => {
        let debugList = [];
        let map = {};

        let parts = i.split('&');
        let params = parts.map(innserSplit);

        for (let i = 0, len = params.length; i < len; i++) {
          let param = params[i][0];
          let name = this._paramsMap[param] || param;
          let value = decodeURIComponent(params[i][1]);
          map[param] = {
            value: value,
            name: name
          };
          debugList.push({
            param: param,
            value: value,
            name: name
          });
        }

        console.table(map, ['name', 'value']);
        this.fire('app-analytics-hit-debug', {
          debug: debugList
        });

      });
      console.groupEnd();
    },

    /**
     * This method sends GA data in bulk.
     *
     * There are some limitations on a GA server side:
     * - A maximum of 20 hits can be specified per request.
     * - The total size of all hit payloads cannot be greater than 16K bytes.
     * - No single hit payload can be greater than 8K bytes.
     *
     * The input `list` expect to have two parameters:
     * - time {Number} as a number of milliseconds when the original hit took
     * place. This function will calculate the delta between original event
     * and now so the GA server may apply additional calculations.
     * - body {String} as a original body that was to be send.
     *
     * @param {Array} list Array of hits that waren't sent earier.
     */
    _sendBulk: function(list) {
      if (this.disableTracking) {
        return Promise.resolve();
      }
      var now = Date.now();
      // Append delat argument.
      var body = list.map((item, i) => {
        if (i >= 20) {
          return;
        }
        let delta = now - item.time;
        let body = item.body;
        body += '&qt=' + delta;
        return body;
      });
      body = body.join('\n');
      if (this.debug) {
        this._printFromBulk(body);
      }

      return this._transport(body, true).then(() => list);
    },

    _transport: function(body, offline) {
      if (this.disableTracking) {
        return Promise.resolve();
      }
      offline = offline || false;
      if (!navigator.onLine) {
        this._storeOffline(body);
        return;
      }
      var init = {
        method: 'POST',
        body: body
      };
      var url = 'https://www.google-analytics.com';
      if (this.debugEndpoint) {
        url += '/debug';
      }
      url += '/collect';
      if (this.useCacheBooster) {
        url += '?z=' + Date.now();
      }
      return fetch(url, init).then((response) => {
        if (response.status !== 200) {
          if (!offline) {
            this._storeOffline(body);
          } else {
            throw new Error('Unable send data.');
          }
        }
        if (this.debugEndpoint) {
          return response.json().then((result) => {
            this.fire('app-analytics-structure-debug', {
              'debug': result
            });
          });
        }
      }).catch(() => {
        if (!navigator.onLine && !offline) {
          this._storeOffline(body);
          return;
        }
        throw new Error('Unable to send data');
      });
    },
    // Should be implemented by element that tmplements this behavior.
    _storeOffline: function() {},

    __printError: function(e) {
      var msg = 'The <app-analytics> element encountered a problem. ';
      msg += 'Please, repor an isse at ';
      msg += 'https://github.com/advanced-rest-client/app-analytics/issues';
      console.info(msg, e);
    }
  };
})();
</script>
